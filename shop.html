<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‡å±‹ - æˆ¦å›½æ”¾ç½®RPG</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .shop-container { padding: 10px; }
        
        .tab-menu { display: flex; border-bottom: 1px solid #444; margin-bottom: 15px; }
        .tab-btn {
            flex: 1; padding: 10px; background: #222; color: #888; 
            border: 1px solid #444; border-bottom: none; cursor: pointer;
            text-align: center; font-weight: bold;
        }
        .tab-btn.active { background: #332200; color: #d4af37; border-color: #d4af37; }

        .shop-item {
            display: flex; align-items: center; justify-content: space-between;
            background: #222; border: 1px solid #444; padding: 10px; margin-bottom: 10px;
            border-radius: 4px;
        }
        .item-info { flex: 1; }
        .item-name { font-weight: bold; color: #fff; font-size: 1rem; }
        .item-desc { font-size: 0.8rem; color: #aaa; }
        .item-price { color: #ffd700; font-weight: bold; }
        
        .btn-buy, .btn-sell {
            padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        .btn-buy { background: #d4af37; color: #000; box-shadow: 0 2px 0 #8a6d3b; }
        .btn-buy:disabled { background: #555; color: #888; box-shadow: none; cursor: not-allowed; }
        
        .btn-sell { background: #522; color: #fcc; border: 1px solid #844; }

        .treasure-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px;
            max-height: 400px; overflow-y: auto;
        }
        .sell-card {
            background: #111; border: 1px solid #444; padding: 5px; text-align: center;
            cursor: pointer; position: relative; border-radius: 4px;
        }
        .sell-card:hover { border-color: #d4af37; }
        .sell-val { color: #ffd700; font-size: 0.8rem; }
        .sell-rank { font-weight: bold; color: #aaa; font-size: 0.7rem; }
    </style>
</head>
<body>

<header><h1>ä¸‡å±‹ (Shop)</h1></header>

<div class="resource-bar">
    <div><span class="res-icon">ğŸ’°</span><span id="money-disp">0</span></div>
    <div><span class="res-icon">ğŸ«</span><span id="ticket-disp">0</span></div>
    <div><span class="res-icon">ğŸ—ï¸</span><span id="kokoro-disp">0</span></div>
</div>

<div class="container shop-container">
    <div class="tab-menu">
        <div id="tab-buy" class="tab-btn active" onclick="setTab('buy')">è²·ã„ç‰©</div>
        <div id="tab-sell" class="tab-btn" onclick="setTab('sell')">å®¶å®å£²å´</div>
    </div>

    <div id="area-buy">
        <div class="box" style="margin-bottom:10px; font-size:0.85rem; color:#ccc;">
            éŠ€è²¨ã‚’ä½¿ã£ã¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’è³¼å…¥ã§ãã¾ã™ã€‚<br>
            æ‰‹å½¢ã¯ã‚¬ãƒãƒ£ã‚„è¶…æˆ¦è¡“ã«ã€éµã¯æ­¦å°†ã®ç™»ç”¨ã«å¿…è¦ã§ã™ã€‚
        </div>

        <div class="shop-item">
            <div class="item-info">
                <div class="item-name">ğŸ« æ‰‹å½¢</div>
                <div class="item-desc">ã‚¬ãƒãƒ£ã‚„è¶…æˆ¦è¡“ã«ä½¿ç”¨</div>
            </div>
            <div style="text-align:right; margin-right:10px;">
                <div class="item-price" id="price-ticket">500 éŠ­</div>
            </div>
            <button class="btn-buy" onclick="buyItem('ticket')">è³¼å…¥</button>
        </div>

        <div class="shop-item">
            <div class="item-info">
                <div class="item-name">ğŸ—ï¸ ã‚³ã‚³ãƒ­ã®éµ</div>
                <div class="item-desc">é«˜ãƒ¬ã‚¢æ­¦å°†ã®ç™»ç”¨ã«å¿…é ˆ</div>
            </div>
            <div style="text-align:right; margin-right:10px;">
                <div class="item-price" id="price-kokoro">10,000 éŠ­</div>
            </div>
            <button class="btn-buy" onclick="buyItem('kokoro')">è³¼å…¥</button>
        </div>
    </div>

    <div id="area-sell" style="display:none;">
        <div class="box" style="margin-bottom:10px; font-size:0.85rem; color:#ccc;">
            åé›†ã—ãŸå®¶å®ã‚’å£²å´ã—ã¦éŠ€è²¨ã«ã—ã¾ã™ã€‚<br>
            <span style="color:#f66;">â€»å£²å´ã™ã‚‹ã¨ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰æ¶ˆãˆã¾ã™ï¼ˆå†å…¥æ‰‹å¯èƒ½ï¼‰ã€‚</span>
        </div>
        <div id="treasure-list" class="treasure-grid"></div>
        <div id="no-treasure-msg" style="text-align:center; padding:20px; color:#888; display:none;">
            å£²å´ã§ãã‚‹å®¶å®ãŒã‚ã‚Šã¾ã›ã‚“
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
    <a href="deck.html">ç·¨æˆ</a>
    <a href="battle.html">å‡ºé™£</a>
    <a href="gacha.html">ã‚¬ãƒãƒ£</a>
</nav>

<script src="game_core.js"></script>
<script>
    let currentSave = loadSaveData();

    window.onload = function() {
        updateDisplay();
        renderSellList();
        
        // ä¾¡æ ¼è¡¨ç¤ºæ›´æ–°
        if(typeof SHOP_PRICES !== 'undefined') {
            document.getElementById('price-ticket').textContent = SHOP_PRICES.ticket.toLocaleString() + " éŠ­";
            document.getElementById('price-kokoro').textContent = SHOP_PRICES.kokoro.toLocaleString() + " éŠ­";
        }
    };

    function updateDisplay() {
        document.getElementById('money-disp').textContent = (currentSave.money || 0).toLocaleString();
        document.getElementById('ticket-disp').textContent = (currentSave.items.ticket || 0).toLocaleString();
        document.getElementById('kokoro-disp').textContent = (currentSave.items.kokoro || 0).toLocaleString();
    }

    function setTab(mode) {
        document.getElementById('tab-buy').className = mode==='buy' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('tab-sell').className = mode==='sell' ? 'tab-btn active' : 'tab-btn';
        document.getElementById('area-buy').style.display = mode==='buy' ? 'block' : 'none';
        document.getElementById('area-sell').style.display = mode==='sell' ? 'block' : 'none';
    }

    function buyItem(type) {
        if (typeof SHOP_PRICES === 'undefined') { alert("ã‚¨ãƒ©ãƒ¼: game_core.jsã«ä¾¡æ ¼è¨­å®š(SHOP_PRICES)ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
        
        const price = SHOP_PRICES[type];
        if (currentSave.money < price) {
            alert("éŠ€è²¨ãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
            return;
        }

        if (confirm(`éŠ€è²¨ ${price} ã§è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) {
            currentSave.money -= price;
            if (type === 'ticket') currentSave.items.ticket = (currentSave.items.ticket || 0) + 1;
            if (type === 'kokoro') currentSave.items.kokoro = (currentSave.items.kokoro || 0) + 1;
            
            saveData(currentSave);
            updateDisplay();
            alert("è³¼å…¥ã—ã¾ã—ãŸï¼");
        }
    }

    function renderSellList() {
        const list = document.getElementById('treasure-list');
        list.innerHTML = '';
        const collected = currentSave.collected_treasures || [];
        
        if (collected.length === 0) {
            document.getElementById('no-treasure-msg').style.display = 'block';
            return;
        }
        document.getElementById('no-treasure-msg').style.display = 'none';

        // ãƒ©ãƒ³ã‚¯ãŒé«˜ã„é †ã«ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º
        const myTreasures = collected.map(id => TREASURE_DATA.find(t => t.id === id)).filter(t => t);
        myTreasures.sort((a, b) => b.rank - a.rank);

        myTreasures.forEach(t => {
            // å£²å´é¡ = ãƒ©ãƒ³ã‚¯ Ã— å®šæ•°(æœªå®šç¾©ãªã‚‰100)
            const baseMult = (typeof TREASURE_SELL_MULTIPLIER !== 'undefined') ? TREASURE_SELL_MULTIPLIER : 100;
            const sellPrice = t.rank * baseMult;

            const div = document.createElement('div');
            div.className = 'sell-card';
            div.onclick = () => sellTreasure(t.id, t.name, sellPrice);
            div.innerHTML = `
                <div class="sell-rank">â˜…${t.rank}</div>
                <div style="font-size:0.8rem; font-weight:bold; margin:2px 0;">${t.name}</div>
                <div style="font-size:0.7rem; color:#aaa;">${t.type}</div>
                <div class="sell-val">${sellPrice} éŠ­</div>
            `;
            list.appendChild(div);
        });
    }

    function sellTreasure(id, name, price) {
        if (confirm(`å®¶å®ã€${name}ã€‘ã‚’å£²å´ã—ã¾ã™ã‹ï¼Ÿ\nå£²å´é¡: ${price} éŠ­\n(ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã™)`)) {
            const idx = currentSave.collected_treasures.indexOf(id);
            if (idx !== -1) {
                currentSave.collected_treasures.splice(idx, 1); // å‰Šé™¤
                currentSave.money += price;
                saveData(currentSave);
                updateDisplay();
                renderSellList();
                alert(`å£²å´ã—ã¾ã—ãŸã€‚\n+${price} éŠ­`);
            }
        }
    }
</script>
</body>
</html>