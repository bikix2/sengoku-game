<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>編成 - 戦国放置RPG</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- デッキエリア --- */
        .deck-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            padding: 10px;
            background: #222;
            border-bottom: 2px solid #d4af37;
        }
        .deck-slot {
            width: 30%;
            height: 110px;
            border: 2px dashed #555;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            background: #1a1a1a;
        }
        .deck-slot.filled {
            border: 2px solid #d4af37;
            background: #332200;
        }
        .slot-label {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #aaa;
            font-size: 0.7rem;
            padding: 0 5px;
            border: 1px solid #444;
        }
        .char-icon { width: 45px; height: 45px; object-fit: cover; border: 1px solid #777; margin-bottom: 3px; }
        .char-name { font-size: 0.7rem; font-weight: bold; color: #fff; text-align: center; white-space: nowrap; overflow: hidden; width: 90%; }
        .char-war { font-size: 0.7rem; color: #f88; }
        
        /* --- リストエリア --- */
        .char-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            gap: 6px;
            padding: 10px;
            max-height: 500px;
            overflow-y: auto;
        }
        .char-card {
            background: #222;
            border: 1px solid #444;
            padding: 5px;
            text-align: center;
            cursor: pointer;
            position: relative;
        }
        .char-card:hover { background: #333; border-color: #666; }
        .char-card.in-deck { opacity: 0.6; border-color: #d4af37; background: #221; }
        .deck-badge {
            position: absolute; top: 0; left: 0;
            background: #d4af37; color: #000;
            font-size: 0.6rem; padding: 1px 4px; font-weight: bold;
        }

        /* --- モーダル --- */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; align-items:center; justify-content:center; }
        .modal-content { background:#222; border:2px solid #d4af37; padding:20px; width:90%; max-width:350px; border-radius:8px; text-align:center; color:#ccc; }
        .modal-img { max-width: 120px; border: 2px solid #555; margin: 10px auto; display:block; }
        .btn-act { width:100%; padding:10px; margin-top:8px; border:none; cursor:pointer; font-weight:bold; border-radius:4px; font-size:0.9rem; }
        .btn-equip { background: #d4af37; color:#000; }
        .btn-sell { background: #522; color:#fcc; border:1px solid #844; }
        .btn-close { background: #444; color:#fff; border:1px solid #666; margin-top:15px; }

        .sort-area { padding: 5px 10px; text-align: right; background: #111; border-bottom: 1px solid #333; font-size:0.8rem; }
        .rarity-UR { color: #f0f; font-weight: bold; }
        .rarity-SSR { color: #fd0; font-weight: bold; }
        .rarity-SR { color: #ccc; font-weight: bold; }
        .rarity-R { color: #d94; font-weight: bold; }
    </style>
</head>
<body>

<header><h1>部隊編成</h1></header>

<div class="container">
    <div style="text-align:center; padding:5px; color:#ccc; font-size:0.9rem;">
        総戦力: <span id="total-war" style="color:#f88; font-weight:bold; font-size:1.1rem;">0</span>
    </div>

    <div class="deck-container">
        <div class="deck-slot" id="slot-0" onclick="removeFromDeck(0)"></div>
        <div class="deck-slot" id="slot-1" onclick="removeFromDeck(1)"></div>
        <div class="deck-slot" id="slot-2" onclick="removeFromDeck(2)"></div>
    </div>

    <div class="box">
        <div class="sort-area">
            所持数: <span id="count-disp">0</span>
            <button onclick="toggleSort()" style="margin-left:10px; padding:2px 8px; font-size:0.75rem;">並替</button>
        </div>
        <div id="char-list" class="char-list"></div>
    </div>
</div>

<div id="detail-modal" class="modal">
    <div class="modal-content">
        <h3 id="m-name" style="color:#d4af37; margin:5px 0;"></h3>
        <div id="m-rarity" style="font-weight:bold;"></div>
        <img id="m-img" src="" class="modal-img" onerror="this.style.display='none'">
        
        <div style="display:flex; justify-content:space-around; margin-bottom:10px; font-size:0.9rem;">
            <div>戦力: <span id="m-war" style="color:#f88; font-weight:bold;"></span></div>
            <div>兵数: <span id="m-hp" style="color:#8f8; font-weight:bold;"></span></div>
        </div>
        
        <div style="background:#332200; padding:8px; border-radius:4px; text-align:left; font-size:0.8rem; margin-bottom:15px;">
            <div style="color:#d4af37; font-weight:bold;">特技: <span id="m-skill-name"></span></div>
            <div id="m-skill-desc" style="color:#ccc;"></div>
        </div>

        <div id="m-actions"></div>
        <button class="btn-act btn-close" onclick="closeModal()">閉じる</button>
    </div>
</div>

<nav class="bottom-nav">
    <a href="index.html">ホーム</a>
    <a href="deck.html" class="active">編成</a>
    <a href="battle.html">出陣</a>
    <a href="gacha.html">ガチャ</a>
</nav>

<script src="character_data.js"></script>
<script src="game_core.js"></script>
<script>
    let currentSave = loadSaveData();
    let sortMode = 'rarity'; // rarity, power
    let selectedCharId = null;

    window.onload = function() {
        if(typeof checkAndDistributeStarter === 'function') {
            const res = checkAndDistributeStarter();
            if (res.success) {
                alert(`【初期特典】「${res.rarity}${res.name}」が編成所に入りました！`);
                currentSave = loadSaveData();
            }
        }
        updateView();
    };

    function updateView() {
        renderDeck();
        renderList();
    }

    function renderDeck() {
        let totalWar = 0;
        currentSave.deck.forEach((charId, index) => {
            const slot = document.getElementById(`slot-${index}`);
            const label = index===0?'大将':(index===1?'中堅':'先鋒');
            
            if (charId) {
                const char = getCharacterById(charId);
                if (char) {
                    slot.className = 'deck-slot filled';
                    slot.innerHTML = `
                        <span class="slot-label">${label}</span>
                        <img src="jpg/${char.image}" class="char-icon" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iIzMzMyIvPjwvc3ZnPg=='">
                        <div class="char-name rarity-${char.rarity}">${char.name}</div>
                        <div class="char-war">戦:${char.war}</div>
                    `;
                    totalWar += char.war;
                } else {
                    currentSave.deck[index] = null; // データ不整合修正
                    slot.className = 'deck-slot';
                    slot.innerHTML = `<span class="slot-label">${label}</span><span style="font-size:0.8rem; color:#666;">(空き)</span>`;
                }
            } else {
                slot.className = 'deck-slot';
                slot.innerHTML = `<span class="slot-label">${label}</span><span style="font-size:0.8rem; color:#666;">(空き)</span>`;
            }
        });
        document.getElementById('total-war').textContent = totalWar;
    }

    function renderList() {
        const list = document.getElementById('char-list');
        list.innerHTML = '';
        
        let chars = currentSave.owned_ids.map(id => getCharacterById(id)).filter(c => c);
        document.getElementById('count-disp').textContent = chars.length;

        // ソート
        chars.sort((a, b) => {
            if (sortMode === 'rarity') {
                const rMap = { "LOB":6, "UR":5, "SSR":4, "SR":3, "R":2, "C":1, "N":0 };
                if (rMap[b.rarity] !== rMap[a.rarity]) return rMap[b.rarity] - rMap[a.rarity];
            }
            return b.war - a.war;
        });

        chars.forEach(c => {
            const deckIndex = currentSave.deck.indexOf(c.id);
            const isDeck = deckIndex !== -1;
            
            const div = document.createElement('div');
            div.className = `char-card ${isDeck ? 'in-deck' : ''}`;
            div.onclick = () => openModal(c, isDeck);
            
            div.innerHTML = `
                ${isDeck ? '<span class="deck-badge">編成中</span>' : ''}
                <div style="font-size:0.7rem; color:${getRarityColor(c.rarity)}">${c.rarity}</div>
                <img src="jpg/${c.image}" style="width:40px;height:40px;object-fit:cover;" onerror="this.style.display='none'">
                <div style="font-size:0.75rem; font-weight:bold; white-space:nowrap; overflow:hidden;">${c.name}</div>
                <div style="font-size:0.7rem; color:#f88;">戦:${c.war}</div>
            `;
            list.appendChild(div);
        });
    }

    // --- 操作ロジック ---

    function removeFromDeck(index) {
        if (currentSave.deck[index]) {
            currentSave.deck[index] = null;
            saveData(currentSave);
            updateView();
        }
    }

    function openModal(char, isDeck) {
        selectedCharId = char.id;
        document.getElementById('m-name').textContent = char.name;
        document.getElementById('m-rarity').textContent = char.rarity;
        document.getElementById('m-rarity').className = `rarity-${char.rarity}`;
        document.getElementById('m-img').src = `jpg/${char.image}`;
        document.getElementById('m-war').textContent = char.war;
        document.getElementById('m-hp').textContent = char.hp;
        document.getElementById('m-skill-name').textContent = char.skill ? char.skill.name : "なし";
        document.getElementById('m-skill-desc').textContent = char.skill ? char.skill.desc : "-";

        const actDiv = document.getElementById('m-actions');
        actDiv.innerHTML = '';

        if (isDeck) {
            actDiv.innerHTML = `<button class="btn-act" onclick="toggleDeck(${char.id})" style="background:#555; color:#fff;">編成から外す</button>`;
        } else {
            // 編成ボタン
            actDiv.innerHTML += `<button class="btn-act btn-equip" onclick="toggleDeck(${char.id})">部隊に編成する</button>`;
            
            // 解雇（売却）ボタン
            // RELEASE_RATESの参照 (game_core.jsにある前提、なければフォールバック)
            const rates = (typeof RELEASE_RATES !== 'undefined') ? RELEASE_RATES : { "N":{v:10,t:'m'}, "R":{v:1,t:'t'} };
            const r = rates[char.rarity] || { v:10, t:'m' };
            const rewardText = r.t === 't' ? `手形${r.v}枚` : `銀貨${r.v}`;
            
            actDiv.innerHTML += `<button class="btn-act btn-sell" onclick="sellChar(${char.id}, '${rewardText}', ${r.v}, '${r.t}')">解雇する (＋${rewardText})</button>`;
        }

        document.getElementById('detail-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('detail-modal').style.display = 'none';
    }

    function toggleDeck(id) {
        const idx = currentSave.deck.indexOf(id);
        if (idx !== -1) {
            // 外す
            currentSave.deck[idx] = null;
        } else {
            // 入れる
            const emptyIdx = currentSave.deck.indexOf(null);
            if (emptyIdx !== -1) {
                currentSave.deck[emptyIdx] = id;
            } else {
                // 満員の場合、大将(0)と入れ替える簡易ロジック、あるいはアラート
                // ここではアラートを出して、ユーザーに入れ替えを促す
                if(confirm("部隊が満員です。大将と入れ替えますか？")) {
                    currentSave.deck[0] = id;
                } else {
                    return; 
                }
            }
        }
        saveData(currentSave);
        updateView();
        closeModal();
    }

    function sellChar(id, rewardText, val, type) {
        if(confirm(`本当にこの武将を解雇しますか？\n(報酬: ${rewardText})`)) {
            const idx = currentSave.owned_ids.indexOf(id);
            if (idx !== -1) {
                currentSave.owned_ids.splice(idx, 1);
                if (type === 't') currentSave.items.ticket = (currentSave.items.ticket || 0) + val;
                else currentSave.money = (currentSave.money || 0) + val;
                
                // 解雇実績の更新
                if (!currentSave.records) currentSave.records = {};
                currentSave.records.totalReleased = (currentSave.records.totalReleased || 0) + 1;
                checkAchievements(currentSave);

                saveData(currentSave);
                updateView();
                closeModal();
                alert(`解雇しました。\n${rewardText}を入手しました。`);
            }
        }
    }

    function toggleSort() {
        sortMode = (sortMode === 'rarity') ? 'power' : 'rarity';
        updateView();
    }

    function getRarityColor(r) {
        if(r==='UR')return '#f0f'; if(r==='SSR')return '#fd0'; if(r==='SR')return '#ccc'; if(r==='R')return '#d94'; return '#fff';
    }
</script>
</body>
</html>